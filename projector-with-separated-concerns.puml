@startuml
'https://plantuml.com/sequence-diagram

autonumber

control SpringAppConfig
boundary MvcController
database ConcertEventStore
participant ProjectionMediator as "Projection Mediator\n<<txn script>>"
participant ConcertSalesProjector as "Concert Sales Projector\n<<domain>>"
database ConcertSalesProjectionRepository
database ProjectionMetadataRepository

== Initialization ==

activate ProjectionMetadataRepository
activate ConcertSalesProjectionRepository
SpringAppConfig -> ConcertEventStore: create new
activate ConcertEventStore
ConcertEventStore --> SpringAppConfig: eventStore
SpringAppConfig -> ConcertSalesProjector: create new
activate ConcertSalesProjector
ConcertSalesProjector --> SpringAppConfig: concertSalesProjector
SpringAppConfig -> ProjectionMediator: create(concertSalesProjector,\n    eventStore,\n    metadataRepository,\n    concertSalesProjectionRepository)
activate ProjectionMediator
ProjectionMediator -> ProjectionMetadataRepository: existsByProjectionName(projection name)
ProjectionMetadataRepository --> ProjectionMediator: exists?
alt if metadata does not exist for projection (exists=false)
    ProjectionMediator -> ProjectionMetadataRepository: saveIfNotExists(projection name, 0)
end
ProjectionMediator -> ProjectionMetadataRepository: findLastGlobalEventSequenceFor\n(projectionId)
ProjectionMetadataRepository --> ProjectionMediator: lastGlobalEventSequence
note over ProjectionMediator: this is the "catch up" process
ProjectionMediator -> ConcertEventStore: allEventsAfter\n(lastGlobalEventSequence)
ConcertEventStore --> ProjectionMediator: Stream<event>\n(might be empty)
note over ProjectionMediator: this is "process events"
alt if Stream<event> is NOT empty
    ProjectionMediator -> ConcertSalesProjectionRepository: loadAllRows()
    ConcertSalesProjectionRepository --> ProjectionMediator: projectionRows
    ProjectionMediator -> ConcertSalesProjector: project(projectionRows, Stream<event>)
    ConcertSalesProjector --> ProjectionMediator: Stream<projectionRows> updatedRows
    ProjectionMediator -> ConcertSalesProjectionRepository: save(updatedRows)
    ProjectionMediator -> ProjectionMetadataRepository: save(lastGlobalEventSequence)
end
ProjectionMediator -> ConcertEventStore: subscribe\n(projectionMediator)
ConcertEventStore --> ProjectionMediator
ProjectionMediator --> SpringAppConfig: projectionMediator

== Handling Newly Saved Events from the Event Store ==

ConcertEventStore -> ProjectionMediator: handle\n(sequenceCheckpoint, Stream<Event>)
note left of ProjectionMediator: do "process events"

== Viewing the Projection ==

MvcController -> ProjectionMediator: allProjectedSummaries()
ProjectionMediator -> ProjectionMetadataRepository: findLastGlobalEventSequenceFor(projectionId)
ProjectionMetadataRepository --> ProjectionMediator: lastGlobalEventSequence
ProjectionMediator -> ConcertSalesProjectionRepository: load Projection
ConcertSalesProjectionRepository --> ProjectionMediator: projectionRows
alt if new events were loaded from event store
    ProjectionMediator -> ProjectionMediator: catch up (see above)
end

ConcertSalesProjector --> MvcController: List<ProjectedSummaries>

@enduml